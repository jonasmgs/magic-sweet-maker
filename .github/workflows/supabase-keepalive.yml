# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Supabase Keep-Alive

'on':
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:
    inputs:
      test_telegram:
        description: "Enviar alerta de teste no Telegram"
        required: false
        default: "false"

jobs:
  ping:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Ping Supabase health (direct, fallback backend)
        env:
          BACKEND_HEALTH_URL: ${{ vars.BACKEND_HEALTH_URL }}
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          # Anon key nÃ£o Ã© segredo no Supabase, mas pode ser colocado como secret se vocÃª preferir.
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_ANON_KEY_PUBLIC: ${{ vars.SUPABASE_ANON_KEY }}
        run: |
          BACKEND_HEALTH_URL="$(echo -n "$BACKEND_HEALTH_URL" | tr -d '\r' | xargs)"
          SUPABASE_URL="$(echo -n "$SUPABASE_URL" | tr -d '\r' | xargs)"
          SUPABASE_ANON_KEY="$(echo -n "$SUPABASE_ANON_KEY" | tr -d '\r' | xargs)"
          SUPABASE_ANON_KEY_PUBLIC="$(echo -n "$SUPABASE_ANON_KEY_PUBLIC" | tr -d '\r' | xargs)"

          if [ -z "$SUPABASE_ANON_KEY" ] && [ -n "$SUPABASE_ANON_KEY_PUBLIC" ]; then
            SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY_PUBLIC"
          fi

          CHECK_URL=""
          CURL_HEADERS=()

          if [ -n "$SUPABASE_URL" ]; then
            CHECK_URL="${SUPABASE_URL%/}/auth/v1/health"
            if [ -n "$SUPABASE_ANON_KEY" ]; then
              CURL_HEADERS=(-H "apikey: ${SUPABASE_ANON_KEY}" -H "Authorization: Bearer ${SUPABASE_ANON_KEY}")
            fi
          else
            CHECK_URL="$BACKEND_HEALTH_URL"
          fi

          if [ -z "$CHECK_URL" ]; then
            echo "No check URL configured. Set vars.SUPABASE_URL (recommended) or vars.BACKEND_HEALTH_URL."
            exit 1
          fi

          # Make the chosen URL available to the failure steps.
          echo "BACKEND_HEALTH_URL=${CHECK_URL}" >> "$GITHUB_ENV"

          # Retry to avoid false positives from transient network issues.
          MAX_TIME_SECONDS=60
          for attempt in 1 2 3; do
            code="$(curl -sS --connect-timeout 10 -m "$MAX_TIME_SECONDS" -o /dev/null -w "%{http_code}" "${CURL_HEADERS[@]}" "$CHECK_URL" || true)"
            echo "Attempt ${attempt}: HTTP ${code}"
            echo "$code" | grep -E "^(200|204)$" && exit 0
            sleep 5
          done

          exit 1
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Supabase keep-alive failed';
            const body = `O ping falhou. Verifique o endpoint: ${process.env.BACKEND_HEALTH_URL}`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            const existing = issues.find(i => i.title === title);
            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              });
            }
      - name: Telegram alert on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets missing."
            exit 0
          fi
          MESSAGE="ðŸš¨ Supabase offline â€” ${BACKEND_HEALTH_URL}"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "disable_web_page_preview=true" >/dev/null
      - name: Telegram test message
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.test_telegram == 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets missing."
            exit 1
          fi
          MESSAGE="âœ… Teste: alerta Telegram do keep-alive estÃ¡ funcionando."
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "disable_web_page_preview=true" >/dev/null
